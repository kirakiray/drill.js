{"version":3,"file":"drill.min.js","sources":["../src/onion.mjs","../src/use.mjs","../src/config.mjs","../src/main.mjs","../src/component.mjs","../src/base.mjs"],"sourcesContent":["const getOid = () => Math.random().toString(32).slice(2);\n\nexport default class Onion {\n  constructor() {\n    this._middlewares = new Map();\n  }\n\n  use(middleware) {\n    const oid = getOid();\n    this._middlewares.set(oid, middleware);\n    return oid;\n  }\n\n  unuse(oid) {\n    return this._middlewares.delete(oid);\n  }\n\n  async run(context) {\n    let index = -1;\n\n    const middlewares = Array.from(this._middlewares.values());\n\n    const next = async () => {\n      index++;\n      if (index < middlewares.length) {\n        await middlewares[index](context, next);\n      }\n    };\n\n    await next();\n  }\n}\n","import Onion from \"./onion.mjs\";\n\nexport const caches = new Map();\nexport const wrapFetch = async (url, params) => {\n  const d = new URL(url);\n\n  const reUrl = params.includes(\"-direct\") ? url : `${d.origin}${d.pathname}`;\n\n  let fetchObj = caches.get(reUrl);\n\n  if (!fetchObj) {\n    fetchObj = fetch(reUrl);\n    caches.set(reUrl, fetchObj);\n  }\n\n  const resp = await fetchObj;\n\n  return resp.clone();\n};\n\nexport const processor = {};\n\nconst addHandler = (name, handler) => {\n  const oni = processor[name] || (processor[name] = new Onion());\n  oni.use(handler);\n};\n\nexport const use = (name, handler) => {\n  if (name instanceof Function) {\n    handler = name;\n    name = [\"js\", \"mjs\"];\n  }\n\n  if (name instanceof Array) {\n    name.forEach((name) => {\n      addHandler(name, handler);\n    });\n    return;\n  }\n\n  addHandler(name, handler);\n};\n\nuse([\"mjs\", \"js\"], async (ctx, next) => {\n  if (!ctx.result) {\n    const { url, params } = ctx;\n    const d = new URL(url);\n\n    const notHttp = /^blob:/.test(url) || /^data:/.test(url);\n    try {\n      if (notHttp || params.includes(\"-direct\")) {\n        ctx.result = await import(url);\n      } else {\n        ctx.result = await import(`${d.origin}${d.pathname}`);\n      }\n    } catch (error) {\n      const err = wrapError(\n        `Failed to load module ${ctx.realUrl || url}`,\n        error\n      );\n\n      if (notHttp) {\n        console.log(\"Failed to load module:\", ctx);\n      }\n\n      throw err;\n    }\n  }\n\n  await next();\n});\n\nuse([\"txt\", \"html\", \"htm\"], async (ctx, next) => {\n  if (!ctx.result) {\n    const { url, params } = ctx;\n\n    let resp;\n    try {\n      resp = await wrapFetch(url, params);\n    } catch (error) {\n      throw wrapError(`Load ${url} failed`, error);\n    }\n\n    if (!/^2.{2}$/.test(resp.status)) {\n      throw new Error(`Load ${url} failed: status code ${resp.status}`);\n    }\n\n    ctx.result = await resp.text();\n  }\n\n  await next();\n});\n\nuse(\"json\", async (ctx, next) => {\n  if (!ctx.result) {\n    const { url, params } = ctx;\n\n    ctx.result = await wrapFetch(url, params).then((e) => e.json());\n  }\n\n  await next();\n});\n\nuse(\"wasm\", async (ctx, next) => {\n  if (!ctx.result) {\n    const { url, params } = ctx;\n\n    const data = await wrapFetch(url, params).then((e) => e.arrayBuffer());\n\n    const module = await WebAssembly.compile(data);\n    const instance = new WebAssembly.Instance(module);\n\n    ctx.result = instance.exports;\n  }\n\n  await next();\n});\n\nuse(\"css\", async (ctx, next) => {\n  if (!ctx.result) {\n    const { url, element, params } = ctx;\n\n    if (element) {\n      const link = document.createElement(\"link\");\n      link.rel = \"stylesheet\";\n      link.href = url;\n\n      const root = element.getRootNode();\n\n      if (root === document) {\n        root.head.append(link);\n      } else {\n        root.appendChild(link);\n      }\n\n      let f;\n      element.addEventListener(\n        \"disconnected\",\n        (f = (e) => {\n          link.remove();\n          element.removeEventListener(\"disconnected\", f);\n        })\n      );\n    } else {\n      ctx.result = await wrapFetch(url, params).then((e) => e.text());\n    }\n  }\n\n  await next();\n});\n\nconst wrapError = (desc, error) => {\n  const err = new Error(`${desc} \\n  ${error.toString()}`);\n  err.error = error;\n  return err;\n};\n","export const aliasMap = {};\n\nexport default async function config(opts) {\n  const { alias } = opts;\n\n  if (alias) {\n    Object.entries(alias).forEach(([name, path]) => {\n      if (/^@.+/.test(name)) {\n        if (!aliasMap[name]) {\n          if (!/^\\./.test(path)) {\n            aliasMap[name] = path;\n          } else {\n            throw `The address does not match the specification, please use '/' or or the beginning of the protocol: '${path}'`;\n          }\n        } else {\n          throw `Alias already exists: '${name}'`;\n        }\n      }\n    });\n  }\n  return true;\n}\n\nexport const path = (moduleName, baseURI) => {\n  if (moduleName.startsWith(\"http://\") || moduleName.startsWith(\"https://\")) {\n    return moduleName;\n  }\n\n  const [url, ...params] = moduleName.split(\" \");\n\n  let lastUrl = url;\n\n  if (/^@/.test(url)) {\n    const [first, ...args] = url.split(\"/\");\n\n    if (aliasMap[first]) {\n      lastUrl = [aliasMap[first].replace(/\\/$/, \"\"), ...args].join(\"/\");\n    } else {\n      throw `No alias defined ${first}`;\n    }\n  }\n\n  if (typeof location !== \"undefined\") {\n    const base = baseURI ? new URL(baseURI, location.href) : location.href;\n\n    const moduleURL = new URL(lastUrl, base);\n\n    lastUrl = moduleURL.href;\n  }\n\n  if (params.length) {\n    return `${lastUrl} ${params.join(\" \")}`;\n  }\n\n  return lastUrl;\n};\n","import { processor, use } from \"./use.mjs\";\nimport { aliasMap, path } from \"./config.mjs\";\nexport const LOADED = Symbol(\"loaded\");\n\nconst createLoad = (meta, opts) => {\n  if (!meta) {\n    meta = {\n      url: document.location.href,\n    };\n  }\n  const load = (ourl) => {\n    let [url, ...params] = ourl.split(\" \");\n\n    const reurl = path(url, meta.url);\n\n    return agent(reurl, { params, ...opts });\n  };\n  return load;\n};\n\nexport const agent = async (url, opts) => {\n  const urldata = new URL(url);\n  const { pathname } = urldata;\n\n  let type;\n  let realUrl = null;\n\n  opts.params &&\n    opts.params.forEach((e) => {\n      if (/^\\..+/.test(e)) {\n        type = e.replace(/^\\.(.+)/, \"$1\");\n      } else if (/^\\-\\-real/.test(e)) {\n        realUrl = e.replace(/^\\-\\-real\\:/, \"\");\n      }\n    });\n\n  if (!type) {\n    type = pathname.slice(((pathname.lastIndexOf(\".\") - 1) >>> 0) + 2);\n  }\n\n  const ctx = {\n    url,\n    result: null,\n    realUrl,\n    ...opts,\n  };\n\n  const oni = processor[type];\n\n  if (oni) {\n    await oni.run(ctx);\n  } else {\n    ctx.result = fetch(url);\n  }\n\n  if (opts && opts.element) {\n    const { element } = opts;\n    element[LOADED] = true;\n    const event = new Event(\"load\");\n    element.dispatchEvent(event);\n  }\n\n  if (opts.params && opts.params.includes(\"-ctx\")) {\n    return ctx;\n  }\n\n  return ctx.result;\n};\n\nexport default function lm(meta, opts) {\n  return createLoad(meta, opts);\n}\n\nObject.assign(lm, {\n  use,\n});\n","import { agent, LOADED } from \"./main.mjs\";\n\nclass LoadModule extends HTMLElement {\n  constructor(...args) {\n    super(...args);\n\n    this[LOADED] = false;\n\n    Object.defineProperties(this, {\n      loaded: {\n        get: () => this[LOADED],\n      },\n    });\n\n    this._init();\n  }\n\n  _init() {\n    if (this.__initSrc || this.attributes.hasOwnProperty(\"pause\")) {\n      return;\n    }\n\n    let src = this.getAttribute(\"src\");\n\n    if (!src) {\n      return;\n      // throw `The ${this.tagName.toLowerCase()} element requires the src attribut `;\n    }\n    this.__initSrc = src;\n\n    const load = lm(undefined, {\n      element: this,\n    });\n\n    load(src);\n\n    Object.defineProperties(this, {\n      src: {\n        configurable: true,\n        value: src,\n      },\n    });\n  }\n\n  connectedCallback() {\n    const event = new CustomEvent(\"connected\");\n    event.root = this._root = this.getRootNode();\n    this.dispatchEvent(event);\n  }\n\n  disconnectedCallback() {\n    const event = new CustomEvent(\"disconnected\");\n    event.root = this._root;\n    delete this._root;\n    this.dispatchEvent(event);\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    if (name === \"src\") {\n      if (newValue && oldValue === null) {\n        this._init();\n      } else if (this.__initSrc && oldValue && newValue !== this.__initSrc) {\n        console.warn(\n          `${this.tagName.toLowerCase()} change src is invalid, only the first change will be loaded`\n        );\n        this.setAttribute(\"src\", this.__initSrc);\n      }\n    } else if (name === \"pause\" && newValue === null) {\n      this._init();\n    }\n  }\n\n  static get observedAttributes() {\n    return [\"src\", \"pause\"];\n  }\n}\n\nclass LM extends LoadModule {\n  constructor(...args) {\n    super(...args);\n  }\n}\n\nconst ready = () => {\n  customElements.define(\"load-module\", LoadModule);\n  customElements.define(\"l-m\", LM);\n  window.removeEventListener(\"load\", ready);\n};\n\nif (document.readyState === \"complete\") {\n  ready();\n} else {\n  window.addEventListener(\"load\", ready);\n}\n","import lm from \"./main.mjs\";\nimport \"./component.mjs\";\nimport config, { path } from \"./config.mjs\";\nlm.config = config;\nlm.path = path;\nObject.freeze(lm);\n\nwindow.lm = lm;\n\nexport default lm;\n"],"names":["Onion","constructor","this","_middlewares","Map","use","middleware","oid","Math","random","toString","slice","set","unuse","delete","async","context","index","middlewares","Array","from","values","next","length","caches","wrapFetch","url","params","d","URL","reUrl","includes","origin","pathname","fetchObj","get","fetch","clone","processor","addHandler","name","handler","Function","forEach","ctx","result","notHttp","test","import","error","err","wrapError","realUrl","console","log","resp","status","Error","text","then","e","json","data","arrayBuffer","module","WebAssembly","compile","instance","Instance","exports","element","link","document","createElement","rel","href","root","getRootNode","f","head","append","appendChild","addEventListener","remove","removeEventListener","desc","aliasMap","path","moduleName","baseURI","startsWith","split","lastUrl","first","args","replace","join","location","base","LOADED","Symbol","agent","opts","urldata","type","lastIndexOf","oni","run","event","Event","dispatchEvent","lm","meta","ourl","reurl","createLoad","Object","assign","LoadModule","HTMLElement","super","defineProperties","loaded","_init","__initSrc","attributes","hasOwnProperty","src","getAttribute","undefined","load","configurable","value","connectedCallback","CustomEvent","_root","disconnectedCallback","attributeChangedCallback","oldValue","newValue","warn","tagName","toLowerCase","setAttribute","observedAttributes","LM","ready","customElements","define","window","readyState","config","alias","entries","freeze"],"mappings":"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"}